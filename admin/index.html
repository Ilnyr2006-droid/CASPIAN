<script>
  function openIdentityAndFixHash() {
    const h = window.location.hash || "";

    // 1) Если пришли с confirm / recovery — добавим type, если его нет
    if (h.includes("confirmation_token") && !h.includes("type=confirmation")) {
      window.location.hash = h + (h.includes("?") || h.includes("&") ? "&" : "&") + "type=confirmation";
      return;
    }

    if (h.includes("recovery_token") && !h.includes("type=recovery")) {
      window.location.hash = h + (h.includes("?") || h.includes("&") ? "&" : "&") + "type=recovery";
      return;
    }

    // 2) Если уже есть нужный type — просто открываем виджет
    if (h.includes("confirmation_token") || h.includes("recovery_token")) {
      window.netlifyIdentity && window.netlifyIdentity.open();
    }
  }

  openIdentityAndFixHash();

  if (window.netlifyIdentity) {
    window.netlifyIdentity.on("init", (user) => {
      if (!user) {
        window.netlifyIdentity.on("login", () => {
          document.location.href = "/admin/";
        });
      }
    });

    window.netlifyIdentity.on("logout", () => {
      document.location.href = "/";
    });
  }
</script>
