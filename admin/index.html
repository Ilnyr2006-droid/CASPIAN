<script>
  (function () {
    if (!window.netlifyIdentity) return;

    // handlers — один раз
    window.netlifyIdentity.on("login", () => {
      document.location.href = "/admin/";
    });

    window.netlifyIdentity.on("logout", () => {
      document.location.href = "/";
    });

    function handleTokenHash() {
      const h = window.location.hash || "";
      const user = window.netlifyIdentity.currentUser && window.netlifyIdentity.currentUser();

      if (user) return;

      if (h.includes("confirmation_token")) {
        if (!h.includes("type=confirmation")) {
          window.location.hash = h + "&type=confirmation";
          return; // hash обновился — дадим странице применить
        }
        window.netlifyIdentity.open();
      }

      if (h.includes("recovery_token")) {
        if (!h.includes("type=recovery")) {
          window.location.hash = h + "&type=recovery";
          return;
        }
        window.netlifyIdentity.open();
      }
    }

    // инициализация + подстраховка
    window.netlifyIdentity.on("init", handleTokenHash);
    handleTokenHash();
  })();
</script>
